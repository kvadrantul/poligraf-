<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отладка изображения</title>
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }
        .image-container {
            margin: 20px 0;
            border: 2px solid #fff;
            padding: 10px;
        }
        .image-container img {
            max-width: 100%;
            display: block;
            margin: 10px 0;
        }
        .info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>Отладка сгенерированного изображения</h1>
    <button onclick="loadImage()">Загрузить изображение из localStorage</button>
    <button onclick="checkBlobUrl()">Проверить Blob URL (из консоли)</button>
    <button onclick="downloadImage()">Скачать изображение</button>
    <button onclick="clearImage()">Очистить</button>
    <div id="info" class="info"></div>
    <div id="imageContainer" class="image-container"></div>

    <script>
        function loadImage() {
            const imageUrl = localStorage.getItem('poligraf-debug-generated-image') || 
                           sessionStorage.getItem('poligraf-debug-generated-image');
            const infoDiv = document.getElementById('info');
            const imageContainer = document.getElementById('imageContainer');
            
            if (!imageUrl) {
                infoDiv.innerHTML = '<p style="color: red;">❌ Изображение не найдено в localStorage или sessionStorage</p>';
                imageContainer.innerHTML = '';
                return;
            }
            
            // Проверяем, не обрезано ли изображение
            const isTruncated = imageUrl.includes('[TRUNCATED]');
            const actualLength = isTruncated ? imageUrl.indexOf('[TRUNCATED]') : imageUrl.length;
            
            infoDiv.innerHTML = `
                <p>✅ Изображение найдено</p>
                <p>Источник: ${localStorage.getItem('poligraf-debug-generated-image') ? 'localStorage' : 'sessionStorage'}</p>
                <p>Тип: ${typeof imageUrl}</p>
                <p>Длина: ${imageUrl.length} символов</p>
                ${isTruncated ? '<p style="color: orange;">⚠️ Изображение обрезано (слишком большое для localStorage)</p>' : ''}
                <p>Начинается с data:image: ${imageUrl.startsWith('data:image')}</p>
                <p>Формат: ${imageUrl.match(/data:image\/([^;]+)/)?.[1] || 'unknown'}</p>
                <p>Превью URL (первые 200 символов):</p>
                <pre style="background: #222; padding: 10px; overflow-x: auto; font-size: 10px;">${imageUrl.substring(0, 200)}...</pre>
                <p>Последние 100 символов:</p>
                <pre style="background: #222; padding: 10px; overflow-x: auto; font-size: 10px;">...${imageUrl.substring(Math.max(0, imageUrl.length - 100))}</pre>
            `;
            
            if (imageUrl.startsWith('data:image')) {
                const img = document.createElement('img');
                img.style.border = '2px solid #fff';
                img.style.background = '#333';
                img.style.minWidth = '200px';
                img.style.minHeight = '200px';
                
                img.onload = () => {
                    const width = img.naturalWidth;
                    const height = img.naturalHeight;
                    imageContainer.innerHTML = `
                        <p>✅ Изображение успешно загружено</p>
                        <p>Размеры: ${width}x${height} пикселей</p>
                        <p>Размер файла: ~${(imageUrl.length * 3 / 4 / 1024).toFixed(2)} KB</p>
                    `;
                    imageContainer.appendChild(img);
                    
                    // Пробуем также через canvas для проверки
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                        console.log('Canvas test - изображение валидное, можно перерисовать');
                    } catch (e) {
                        console.error('Canvas test failed:', e);
                    }
                };
                
                img.onerror = (e) => {
                    console.error('Image load error:', e);
                    imageContainer.innerHTML = `
                        <p style="color: red;">❌ Ошибка загрузки изображения</p>
                        <p>Попробуем альтернативные методы...</p>
                    `;
                    
                    // Пробуем через blob
                    try {
                        const base64Data = imageUrl.split(',')[1];
                        if (!base64Data) {
                            imageContainer.innerHTML += '<p style="color: red;">❌ Нет base64 данных в URL</p>';
                            return;
                        }
                        
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'image/jpeg' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        const img2 = document.createElement('img');
                        img2.src = blobUrl;
                        img2.style.border = '2px solid #0f0';
                        img2.style.background = '#333';
                        img2.onload = () => {
                            imageContainer.innerHTML += '<p style="color: green;">✅ Изображение загружено через Blob URL</p>';
                            imageContainer.appendChild(img2);
                        };
                        img2.onerror = () => {
                            imageContainer.innerHTML += '<p style="color: red;">❌ Blob URL тоже не работает</p>';
                        };
                    } catch (e) {
                        imageContainer.innerHTML += `<p style="color: red;">❌ Ошибка создания Blob: ${e.message}</p>`;
                    }
                };
                
                img.src = imageUrl;
            } else {
                imageContainer.innerHTML = '<p style="color: red;">❌ Это не data:image URL</p>';
            }
        }
        
        function clearImage() {
            localStorage.removeItem('poligraf-debug-generated-image');
            sessionStorage.removeItem('poligraf-debug-generated-image');
            document.getElementById('info').innerHTML = '<p>Очищено</p>';
            document.getElementById('imageContainer').innerHTML = '';
        }
        
        function checkBlobUrl() {
            if (window.poligrafDebugImageBlobUrl) {
                const img = document.createElement('img');
                img.src = window.poligrafDebugImageBlobUrl;
                img.style.border = '2px solid #0ff';
                img.style.background = '#333';
                document.getElementById('imageContainer').innerHTML = '<p>Изображение через Blob URL (из window.poligrafDebugImageBlobUrl):</p>';
                document.getElementById('imageContainer').appendChild(img);
            } else {
                alert('window.poligrafDebugImageBlobUrl не найден. Откройте консоль в основном приложении и проверьте, создан ли blob URL.');
            }
        }
        
        function downloadImage() {
            const imageUrl = localStorage.getItem('poligraf-debug-generated-image') || 
                           sessionStorage.getItem('poligraf-debug-generated-image');
            
            if (!imageUrl || !imageUrl.startsWith('data:image')) {
                alert('❌ Изображение не найдено или невалидное');
                return;
            }
            
            try {
                // Извлекаем base64 данные
                const base64Data = imageUrl.split(',')[1];
                if (!base64Data) {
                    alert('❌ Не удалось извлечь base64 данные');
                    return;
                }
                
                // Определяем формат изображения
                const formatMatch = imageUrl.match(/data:image\/([^;]+)/);
                const format = formatMatch ? formatMatch[1] : 'jpeg';
                const mimeType = `image/${format}`;
                
                // Конвертируем base64 в blob
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mimeType });
                
                // Создаем URL для скачивания
                const blobUrl = URL.createObjectURL(blob);
                
                // Создаем элемент <a> для скачивания
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `poligraf-generated-image-${Date.now()}.${format}`;
                link.style.display = 'none';
                
                // Добавляем в DOM, кликаем и удаляем
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Освобождаем память
                setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
                
                console.log(`✅ Изображение скачано: poligraf-generated-image-${Date.now()}.${format}`);
            } catch (e) {
                console.error('❌ Ошибка при скачивании изображения:', e);
                alert(`❌ Ошибка при скачивании: ${e.message}`);
            }
        }
        
        // Автоматически загружаем при открытии страницы
        window.onload = loadImage;
    </script>
</body>
</html>

