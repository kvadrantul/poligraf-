# High-Level Design (HLD) - Poligraf Mini App

## 🏗️ Общая архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         FRONTEND (Client)                           │
│                    Telegram Mini App / Browser                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  index.html                                                  │  │
│  │  - UI компоненты (input, buttons, result area)               │  │
│  │  - Telegram Web App API инициализация                        │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  app.js (Frontend Logic)                                     │  │
│  │  ├─ Управление UI состоянием                                 │  │
│  │  ├─ Формирование промптов (системный + пользовательский)     │  │
│  │  ├─ Рендеринг React компонентов в iframe                     │  │
│  │  ├─ Работа с localStorage (userId, код, промпты)              │  │
│  │  └─ Отправка запросов на Backend                             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  styles.css                                                  │  │
│  │  - Стили интерфейса                                          │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              │ API Calls
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      BACKEND (Vercel Serverless)                     │
│                    https://poligraf-black.vercel.app                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  /api/generate.js (Model API)                                │  │
│  │  ├─ Принимает: { userPrompt, image, provider }              │  │
│  │  ├─ Выбирает провайдера (v0.dev / Lovable / OpenAI)        │  │
│  │  ├─ Формирует запрос к внешнему API                          │  │
│  │  ├─ Извлекает код из ответа (extractCodeFromResponse)        │  │
│  │  └─ Возвращает: { result, code, provider }                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  /api/v0/create-project.js                                   │  │
│  │  ├─ Создает проект в v0.dev Platform API                     │  │
│  │  ├─ Создает чат в проекте                                    │  │
│  │  └─ Возвращает: { projectId, chatId }                        │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  /api/v0/iterate.js                                          │  │
│  │  ├─ Отправляет сообщение в существующий чат                  │  │
│  │  ├─ Polling ответа от assistant                             │  │
│  │  └─ Возвращает: { result, code }                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  /api/v0/get-project-content.js                               │  │
│  │  ├─ Получает сообщения из чата                               │  │
│  │  ├─ Извлекает код из последнего сообщения                    │  │
│  │  └─ Возвращает: { code, hasContent }                        │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  /api/v0/save-to-project.js                                  │  │
│  │  ├─ Сохраняет код в проект через сообщение в чат            │  │
│  │  └─ Возвращает: { success }                                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              │ API Calls
                              │ (Bearer Token)
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    EXTERNAL APIs                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  v0.dev Model API                                           │  │
│  │  POST https://api.v0.dev/v1/chat/completions               │  │
│  │  ├─ Быстрая генерация кода                                  │  │
│  │  ├─ Поддержка изображений (multimodal)                      │  │
│  │  └─ Возвращает: React/TSX код                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  v0.dev Platform API                                        │  │
│  │  ├─ POST /v1/projects (создание проекта)                    │  │
│  │  ├─ POST /v1/chats (создание чата)                          │  │
│  │  ├─ POST /v1/chats/:id/messages (отправка сообщения)        │  │
│  │  ├─ GET /v1/chats/:id (получение сообщений)                 │  │
│  │  └─ Хранение проектов и истории чатов                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Lovable API (планируется)                                   │  │
│  │  └─ Альтернативный провайдер для генерации                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  OpenAI API (fallback)                                      │  │
│  │  └─ Используется если v0.dev недоступен                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CLIENT-SIDE STORAGE                              │
│                      (localStorage)                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  poligraf-user-id                                            │  │
│  │  └─ Идентификатор пользователя                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  poligraf-last-code-${userId}                                │  │
│  │  └─ Последний сгенерированный код (raw)                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  poligraf-last-html-${userId}                                │  │
│  │  └─ Последний отрендеренный HTML (для референса)            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  poligraf-last-prompt-${userId}                              │  │
│  │  └─ Последний промпт пользователя                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  poligraf-provider                                            │  │
│  │  └─ Выбранный провайдер (v0 / lovable)                       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📊 Поток данных: Новая генерация

```
┌─────────────┐
│  Пользователь│
│  вводит промпт│
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Frontend (app.js)                                           │
│  ├─ Формирует промпт:                                        │
│  │  ├─ Системный промпт (если включен)                      │
│  │  ├─ HTML референс (если есть в localStorage)             │
│  │  └─ Промпт пользователя                                  │
│  ├─ Прикрепляет изображение (если есть)                      │
│  └─ Выбирает провайдера (v0 / Lovable)                      │
└──────┬───────────────────────────────────────────────────────┘
       │
       │ POST /api/generate
       │ { userPrompt, image, provider }
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Backend (/api/generate.js)                                  │
│  ├─ Получает API ключ из env (V0_API_KEY / LOVABLE_API_KEY) │
│  ├─ Формирует запрос к внешнему API                         │
│  │  ├─ v0.dev: POST /v1/chat/completions                    │
│  │  └─ Lovable: POST /v1/chat/completions (TODO)            │
│  ├─ Извлекает код из ответа (extractCodeFromResponse)        │
│  │  └─ Убирает thinking блоки, берет последний code block   │
│  └─ Возвращает: { result, code, provider }                  │
└──────┬───────────────────────────────────────────────────────┘
       │
       │ { result, code, provider }
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Frontend (app.js)                                           │
│  ├─ displayResult(code)                                      │
│  │  ├─ Определяет тип: React код / HTML / текст             │
│  │  ├─ Если React: renderReactComponent() в iframe           │
│  │  │  ├─ Создает iframe                                    │
│  │  │  ├─ Загружает React, ReactDOM, Babel                  │
│  │  │  ├─ Трансформирует JSX через Babel                    │
│  │  │  └─ Рендерит компонент                                │
│  │  └─ Если HTML: рендерит напрямую в iframe                │
│  ├─ savePromptAndMarkup()                                    │
│  │  ├─ Сохраняет код в localStorage                         │
│  │  ├─ Сохраняет HTML в localStorage                        │
│  │  └─ Сохраняет промпт в localStorage                      │
│  └─ Отображает результат пользователю                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 Поток данных: Итерация (правка)

```
┌─────────────┐
│  Пользователь│
│  просит правку│
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Frontend (app.js)                                           │
│  ├─ Проверяет localStorage: есть ли сохраненный HTML?       │
│  ├─ Формирует промпт:                                        │
│  │  ├─ Системный промпт (если включен)                      │
│  │  ├─ "возьми за основу вот этот HTML: [HTML из localStorage]"
│  │  └─ "и сделай [промпт пользователя]"                      │
│  └─ Прикрепляет изображение (если есть)                      │
└──────┬───────────────────────────────────────────────────────┘
       │
       │ POST /api/generate
       │ { userPrompt, image, provider }
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Backend (/api/generate.js)                                  │
│  └─ Аналогично новой генерации                               │
└──────┬───────────────────────────────────────────────────────┘
       │
       │ { result, code, provider }
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Frontend (app.js)                                           │
│  ├─ displayResult(code) - отображает новый результат         │
│  └─ savePromptAndMarkup() - обновляет localStorage          │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔑 Ключевые компоненты Backend

### 1. `/api/generate.js` - Основной endpoint для генерации

**Что делает:**
- Принимает промпт пользователя, изображение (опционально), провайдера
- Выбирает API провайдера (v0.dev / Lovable / OpenAI)
- Формирует запрос к внешнему API
- Извлекает код из ответа (убирает thinking блоки)
- Возвращает чистый код

**Входные данные:**
```json
{
  "userPrompt": "Создай визитку...",
  "image": "data:image/jpeg;base64,..." (опционально),
  "provider": "v0" | "lovable"
}
```

**Выходные данные:**
```json
{
  "result": "export default function...",
  "code": "export default function...",
  "provider": "v0.dev"
}
```

### 2. `/api/v0/create-project.js` - Создание проекта

**Что делает:**
- Создает проект в v0.dev Platform API
- Создает чат в проекте
- Возвращает projectId и chatId

**Использование:** В текущей архитектуре НЕ используется (перешли на localStorage)

### 3. `/api/v0/iterate.js` - Итерация в чате

**Что делает:**
- Отправляет сообщение в существующий чат
- Polling ответа от assistant
- Возвращает сгенерированный код

**Использование:** В текущей архитектуре НЕ используется (используем Model API)

### 4. `/api/v0/get-project-content.js` - Получение контента проекта

**Что делает:**
- Получает сообщения из чата
- Извлекает код из последнего сообщения
- Возвращает код и флаг hasContent

**Использование:** В текущей архитектуре НЕ используется (используем localStorage)

### 5. `/api/v0/save-to-project.js` - Сохранение в проект

**Что делает:**
- Сохраняет код в проект через отправку сообщения в чат

**Использование:** В текущей архитектуре НЕ используется

---

## 💾 Хранение данных

### Frontend (localStorage)

**Текущая архитектура (упрощенная):**
- `poligraf-user-id` - ID пользователя
- `poligraf-last-code-${userId}` - Последний код
- `poligraf-last-html-${userId}` - Последний HTML (для референса)
- `poligraf-last-prompt-${userId}` - Последний промпт
- `poligraf-provider` - Выбранный провайдер

**Старая архитектура (Platform API):**
- `v0-project-${userId}` - { projectId, chatId }

### Backend

**Переменные окружения (Vercel):**
- `V0_API_KEY` - API ключ v0.dev
- `LOVABLE_API_KEY` - API ключ Lovable (опционально)
- `OPENAI_API_KEY` - API ключ OpenAI (fallback)

---

## 🔄 Упрощенная архитектура (текущая)

После упрощения архитектуры:

1. **НЕ создаем проекты** в v0.dev Platform API
2. **НЕ используем Platform API** для итераций
3. **Используем только Model API** (`/api/generate.js`)
4. **Храним все в localStorage** на клиенте
5. **Для итераций** передаем HTML референс в промпте

**Преимущества:**
- ✅ Быстрее (нет polling, нет создания проектов)
- ✅ Проще (меньше endpoints)
- ✅ Дешевле (меньше запросов к API)

**Недостатки:**
- ❌ Нет истории в v0.dev
- ❌ Нет синхронизации между устройствами
- ❌ Данные могут потеряться при очистке браузера

---

## 🎯 Роль Backend

**Backend выполняет роль Proxy/Adapter:**

1. **Скрывает API ключи** от клиента
2. **Адаптирует запросы** к разным провайдерам
3. **Очищает ответы** (убирает thinking, извлекает код)
4. **Обрабатывает ошибки** и возвращает понятные сообщения
5. **Добавляет CORS заголовки** для работы из браузера

**Backend НЕ хранит:**
- ❌ Данные пользователей
- ❌ Историю генераций
- ❌ Проекты

**Все хранится на клиенте в localStorage!**

