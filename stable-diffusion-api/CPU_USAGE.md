# üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU —è–¥–µ—Ä –≤ Stable Diffusion API

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é PyTorch –º–æ–∂–µ—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è–¥—Ä–∞ CPU, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–µ–¥–ª–µ–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

## –†–µ—à–µ–Ω–∏–µ
–ö–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **–≤—Å–µ—Ö 10 —è–¥–µ—Ä** Mac Mini M4:
- 4 performance cores
- 6 efficiency cores

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∫–æ–¥–µ

–í `main.py` –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```python
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä
NUM_CPU_CORES = multiprocessing.cpu_count()

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º PyTorch
torch.set_num_threads(NUM_CPU_CORES)
torch.set_num_interop_threads(NUM_CPU_CORES)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ.setdefault("OMP_NUM_THREADS", str(NUM_CPU_CORES))
os.environ.setdefault("MKL_NUM_THREADS", str(NUM_CPU_CORES))
os.environ.setdefault("NUMEXPR_NUM_THREADS", str(NUM_CPU_CORES))
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CPU

### –í–∞—Ä–∏–∞–Ω—Ç 1: Activity Monitor (macOS)
1. –û—Ç–∫—Ä–æ–π—Ç–µ **Activity Monitor** (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã)
2. –ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å `Python` (SD API —Å–µ—Ä–≤–µ—Ä)
3. –í–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - **CPU %** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–ª–∏–∑–∫–æ –∫ 1000% (10 —è–¥–µ—Ä √ó 100%)
   - **Threads** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 2: –¢–µ—Ä–º–∏–Ω–∞–ª (htop/top)
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ htop (–µ—Å–ª–∏ –Ω–µ—Ç)
brew install htop

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ htop
htop

# –ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å Python –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```bash
cd stable-diffusion-api
./test_cpu_usage.sh
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- –ù–∞–π–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å SD API —Å–µ—Ä–≤–µ—Ä–∞
- –ó–∞–ø—É—Å—Ç–∏—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ CPU –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ü–æ–∫–∞–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:
- **CPU Usage**: 800-1000% (8-10 —è–¥–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç)
- **Threads**: 10+ –ø–æ—Ç–æ–∫–æ–≤
- **–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**: 30-90 —Å–µ–∫—É–Ω–¥ –¥–ª—è LCM Dreamshaper (2 —à–∞–≥–∞)

### –ï—Å–ª–∏ CPU –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
- **CPU Usage**: <100% (—Ç–æ–ª—å–∫–æ 1 —è–¥—Ä–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- **Threads**: 1-2 –ø–æ—Ç–æ–∫–∞
- **–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**: 10-15 –º–∏–Ω—É—Ç

## –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä**:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä (Ctrl+C)

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ
cd stable-diffusion-api
./start_server.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
cd stable-diffusion-api
source venv/bin/activate  # –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ venv
python3 main.py
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

```
üîß Detected CPU cores: 10
‚úÖ PyTorch configured to use 10 threads
‚úÖ PyTorch get_num_threads(): 10
‚úÖ PyTorch get_num_interop_threads(): 10
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –¥—Ä—É–≥–∏–µ —á–∏—Å–ª–∞ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å!

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: CPU –≤—Å–µ –µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Ç–æ–∫–æ–≤
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Python (–∏–∑ venv, –µ—Å–ª–∏ –µ—Å—Ç—å)

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–∂–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤—Å–µ—Ö —è–¥–µ—Ä
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è CPU - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 30-90 —Å–µ–∫—É–Ω–¥
- –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –Ω—É–∂–µ–Ω GPU (CUDA) –∏–ª–∏ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å (LCM Dreamshaper —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ—Ç–æ–∫–æ–≤
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PyTorch —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é: `python3 -c "import torch; print(torch.__version__)"`

