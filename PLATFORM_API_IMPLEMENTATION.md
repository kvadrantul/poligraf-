# Реализация v0 Platform API

## Что сделано

### 1. Новые Backend Endpoints

**`/api/v0/create-project`** - создание проекта и чата
- Принимает: `{ userId }`
- Возвращает: `{ projectId, chatId, userId }`
- Пробует несколько возможных endpoints v0.dev
- Сохраняет projectId и chatId в localStorage на клиенте

**`/api/v0/iterate`** - итерация в чате
- Принимает: `{ projectId, chatId, prompt }`
- Возвращает: `{ result, code, projectId, chatId }`
- Отправляет промпт в существующий чат
- Пробует несколько возможных endpoints

### 2. Frontend изменения

**Идентификация пользователя:**
- Используется Telegram User ID (`tg.initDataUnsafe.user.id`)
- Fallback на временный ID если недоступен

**Хранение проекта:**
- localStorage ключ: `v0-project-{userId}`
- Хранит: `{ projectId, chatId }`
- Счетчик проектов: `v0-projects-count` (максимум 5)

**Логика работы:**
1. При первом запросе → создает проект и чат
2. При последующих → использует существующий проект
3. Если ошибка создания проекта → fallback на Model API

### 3. Защита от лимитов

- Максимум 5 проектов (настраивается в `app.js`: `MAX_PROJECTS`)
- Проверка перед созданием нового проекта
- Сообщение об ошибке при достижении лимита

## Обновлено согласно документации

### Правильные endpoints v0 Platform API

Согласно [официальной документации](https://v0.app/docs/api/platform/overview):
- **Base URL**: `https://api.v0.dev`
- **Создание проекта**: `POST /v1/projects` с `{ name: '...' }`
- **Создание чата**: `POST /v1/chats` с `{ projectId, initialMessage: '...' }`
- **Отправка сообщения**: `POST /v1/chats/:id/messages` с `{ content: '...' }`

### Формат запросов и ответов

Согласно документации:
- **Создание проекта**: `{ name: 'Project Name' }` → возвращает `{ id, ... }`
- **Создание чата**: `{ projectId, initialMessage: '...' }` → возвращает `{ id, ... }`
- **Отправка сообщения**: `{ content: 'prompt text' }` → возвращает `{ messages: [...] }`

**Важно**: После отправки сообщения нужно извлечь код из последнего сообщения assistant в массиве `messages`.

### Лимиты v0.dev

Согласно [документации](https://v0.app/docs/api/platform/overview):
- **Projects**: 100 на аккаунт (в коде установлен лимит 50 для безопасности)
- **Chats**: 1000 на проект
- **Messages**: 10,000 на чат
- **API Requests**: 10,000 в день
- **Chat Messages**: 1,000 в день

### Формат ответа Platform API

Реализация извлекает код из:
1. `responseData.messages` - массив сообщений, ищет последнее от `role: 'assistant'`
2. `responseData.data.messages` - альтернативный формат
3. Fallback на другие поля если структура отличается

**Примечание**: После тестирования может потребоваться доработка извлечения кода в зависимости от реального формата ответа.

## Как тестировать

1. Откройте Mini App
2. Введите первый промпт
3. Проверьте в консоли браузера:
   - Создан ли проект?
   - Сохранен ли в localStorage?
4. Введите второй промпт
5. Проверьте:
   - Используется ли существующий проект?
   - Итерация работает?

## Если Platform API не работает

Приложение автоматически переключится на Model API (старый способ) если:
- Не удалось создать проект
- Не удалось получить существующий проект
- Ошибка при итерации

## Следующие шаги

1. Проверить документацию v0 Platform API
2. Обновить endpoints если неправильные
3. Обновить форматы запросов/ответов
4. Протестировать с реальным API
5. При необходимости добавить backend БД для хранения проектов

